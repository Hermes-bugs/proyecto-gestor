<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TaskFlow - con Supabase</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    :root {
      --bg-body: #121212;
      --bg-card: #1e1e1e;
      --bg-sidebar: #181818;
      --primary: #bb86fc;
      --secondary: #03dac6;
      --danger: #cf6679;
      --text-main: #e0e0e0;
      --text-muted: #a0a0a0;
      --border: #333;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    body { background-color: var(--bg-body); color: var(--text-main); display: flex; height: 100vh; overflow: hidden; }

    .sidebar { width: 250px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; }
    .sidebar h2 { margin-bottom: 20px; font-size: 1.2rem; color: var(--primary); }
    .user-item {
      padding: 15px; margin-bottom: 10px; background: var(--bg-card); border-radius: 8px; cursor: pointer;
      transition: all 0.3s ease; display: flex; align-items: center; justify-content: space-between;
    }
    .user-item:hover, .user-item.active { background: var(--primary); color: #000; transform: translateX(5px); }
    .user-avatar { width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-weight: bold; }

    .main { flex: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .stats { display: flex; gap: 15px; }
    .stat-box { background: var(--bg-card); padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.9rem; }
    .stat-box span { font-weight: bold; color: var(--secondary); }

    .task-form { background: var(--bg-card); padding: 20px; border-radius: 10px; margin-bottom: 20px; display: grid; grid-template-columns: 2fr 2fr 1fr 1fr auto; gap: 10px; align-items: end; border: 1px solid var(--border); }
    input, select { background: #2c2c2c; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 5px; width: 100%; }
    button { cursor: pointer; padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; }
    .btn-add { background: var(--secondary); color: #000; }
    .btn-add:hover { background: #00b3a1; }

    .task-list { display: flex; flex-direction: column; gap: 10px; }
    .task-card {
      background: var(--bg-card); padding: 20px; border-radius: 10px;
      display: flex; justify-content: space-between; align-items: center;
      animation: slideIn 0.4s ease-out; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .task-card.status-pending { border-left: 5px solid #ff9800; }
    .task-card.status-progress { border-left: 5px solid #2196f3; }
    .task-card.status-completed { border-left: 5px solid #4caf50; opacity: 0.7; text-decoration: line-through; }

    .task-info h3 { font-size: 1.1rem; margin-bottom: 5px; }
    .task-info p { font-size: 0.85rem; color: var(--text-muted); }
    .task-meta { font-size: 0.8rem; margin-top: 5px; display: flex; gap: 10px; }
    
    .actions button { margin-left: 5px; padding: 5px 10px; font-size: 0.8rem; }
    .btn-delete { background: var(--danger); color: white; }
    .btn-complete { background: var(--secondary); color: black; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>üë• Usuarios</h2>
  <div id="usersList"></div>
</div>

<main class="main">
  <div class="header">
    <div>
      <h1 id="currentUserTitle">Selecciona un usuario</h1>
      <p id="currentUserSubtitle">Gesti√≥n de tareas personales</p>
    </div>
    <div class="stats" id="statsContainer" style="display:none;">
      <div class="stat-box">Pendientes: <span id="countPending">0</span></div>
      <div class="stat-box">En Progreso: <span id="countProgress">0</span></div>
      <div class="stat-box">Completadas: <span id="countCompleted">0</span></div>
    </div>
  </div>

  <div class="task-form" id="taskFormContainer" style="display:none;">
    <input type="text" id="inputTitle" placeholder="T√≠tulo de la tarea">
    <input type="text" id="inputDesc" placeholder="Descripci√≥n breve">
    <select id="inputStatus">
      <option value="pending">Pendiente</option>
      <option value="progress">En Progreso</option>
      <option value="completed">Completada</option>
    </select>
    <input type="date" id="inputDate">
    <button class="btn-add" onclick="addTask()">+ Agregar</button>
  </div>

  <div id="taskList" class="task-list"></div>
</main>

<script>
  // üîë Configura tu Supabase
  const supabaseUrl = 'https://omwcposhwwgigovhetvy.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9td2Nwb3Nod3dnaWdvdmhldHZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2NTg5NjgsImV4cCI6MjA4MDIzNDk2OH0.6hO7agzsCUQzH2G635tZET2eI2HsnBj7jaHJ0hcLgwA';
  const supabase = supabase.createClient(supabaseUrl, supabaseAnonKey);

  let currentUser = null;

  // üì• Cargar usuarios al inicio
  async function loadUsers() {
    const { data, error } = await supabase.from('users').select('*');
    if (error) { console.error('Error:', error); return; }
    
    const usersList = document.getElementById('usersList');
    usersList.innerHTML = '';
    data.forEach(user => {
      const div = document.createElement('div');
      div.className = 'user-item';
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="user-avatar">${user.name[0]}</div>
          <span>${user.name}</span>
        </div>
        <small>></small>
      `;
      div.onclick = () => selectUser(user);
      usersList.appendChild(div);
    });
  }

  function selectUser(user) {
    document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    
    currentUser = user;
    document.getElementById('currentUserTitle').innerText = `Tareas de ${user.name}`;
    document.getElementById('currentUserSubtitle').innerText = "Gestiona tus pendientes";
    document.getElementById('taskFormContainer').style.display = 'grid';
    document.getElementById('statsContainer').style.display = 'flex';
    
    loadTasks();
  }

  // üì• Cargar tareas del usuario
  async function loadTasks() {
    const { data, error } = await supabase
      .from('tasks')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false });

    if (error) { console.error('Error:', error); return; }

    const list = document.getElementById('taskList');
    list.innerHTML = '';

    let pending = 0, progress = 0, completed = 0;

    if (data.length === 0) {
      list.innerHTML = `<p style="text-align:center; color:gray; margin-top:20px;">No hay tareas.</p>`;
    } else {
      data.forEach(task => {
        if(task.status === 'pending') pending++;
        else if(task.status === 'progress') progress++;
        else completed++;

        const card = document.createElement('div');
        card.className = `task-card status-${task.status}`;
        card.innerHTML = `
          <div class="task-info">
            <h3>${task.title}</h3>
            <p>${task.description || ''}</p>
            <div class="task-meta">
              <span>üìÖ ${task.due_date || 'Sin fecha'}</span>
              <span style="text-transform:uppercase; font-weight:bold; font-size:0.7rem; border:1px solid #555; padding:2px 5px; border-radius:4px;">${task.status}</span>
            </div>
          </div>
          <div class="actions">
            ${task.status !== 'completed' ? `<button class="btn-complete" onclick="completeTask('${task.id}')">‚úî</button>` : ''}
            <button class="btn-delete" onclick="deleteTask('${task.id}')">üóë</button>
          </div>
        `;
        list.appendChild(card);
      });
    }

    document.getElementById('countPending').innerText = pending;
    document.getElementById('countProgress').innerText = progress;
    document.getElementById('countCompleted').innerText = completed;
  }

  // ‚ûï Agregar tarea
  async function addTask() {
    const title = document.getElementById('inputTitle').value.trim();
    const desc = document.getElementById('inputDesc').value.trim();
    const status = document.getElementById('inputStatus').value;
    const date = document.getElementById('inputDate').value || null;

    if (!title) { alert("El t√≠tulo es obligatorio"); return; }

    const { error } = await supabase
      .from('tasks')
      .insert([{ title, description: desc, status, due_date: date, user_id: currentUser.id }]);

    if (error) { console.error('Error:', error); alert('Error al guardar'); return; }

    // Limpiar formulario
    document.getElementById('inputTitle').value = '';
    document.getElementById('inputDesc').value = '';
    document.getElementById('inputDate').value = '';

    loadTasks();
  }

  // ‚úÖ Completar tarea
  async function completeTask(taskId) {
    const { error } = await supabase
      .from('tasks')
      .update({ status: 'completed' })
      .eq('id', taskId);
    if (!error) loadTasks();
  }

  // üóë Eliminar tarea
  async function deleteTask(taskId) {
    if (!confirm("¬øEliminar tarea?")) return;
    const { error } = await supabase
      .from('tasks')
      .delete()
      .eq('id', taskId);
    if (!error) loadTasks();
  }

  // ‚ñ∂Ô∏è Iniciar app
  loadUsers();
</script>
</body>
</html>